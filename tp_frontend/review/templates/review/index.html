{% extends "base.html" %}

{% block title %}Review{% endblock %}
{% block content %}
{% load user_tag %}
{% if not error %}
<div class="row" >
    <div class="col-md-12" id="progress-label">
        <span style="" class="label label-default">Progress</span>
    </div>
    <div class="col-md-12">
        <div class="progress">
            <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: {{ progress.total }}%; color:black">
                {{ progress.total }}%
            </div>
        </div>
    </div>
</div>
<div class="row">
<div class="col-md-11">
{% if concept_type == "entity_url" %}
<div><span style="font-size:11px;border-radius:0;background-color:#286090;" class="label label-default">CONCEPT</span> </a></div>
<div style="margin-top:2px;"><a target="_blank" href="http://en.wikipedia.org/wiki/{{ text.split|join:'_' }}" class="main-link"><span  style="font-size:28px;color: dark-blue">{{text}}</span></a> <small style="font-size: 16px;"> was found <span style="color: black;">{{ frequency }} </span>times in catalog</small></h2></div>
<h5 style="padding-bottom:10px; padding-top:10px; color: #777;">Smarter.Codes thinks that there are various names for <span style="color: black;">{{text}}</span> . But Smarter.Codes can be wrong! Help us understand it better by choosing the right synonms of {{ text }}</h5>
{% else %}
<div><span style="font-size:11px;border-radius:0;" class="label label-default">KEYWORD</span> </div>
<div style="margin-top:2px;"><a target="_blank" href="http://en.wikipedia.org/wiki/{{ text.split|join:'_' }}" class="main-link"><span  style="font-size:28px;color: dark-blue">{{text}}</span></a> <small style="font-size:16px;">   was found <span style="color: black;">{{ frequency }} </span>times in catalog </small></h2></div>
<h5 style="padding-bottom:10px; padding-top:10px; color: #777;">Smarter.Codes thinks of '{{ synonyms|length }} different concepts' when someone talks about {{ text }}. Please help reduce this confusion of Smarter.Codes by choosing 1 concept that it should think when '{{text}}' is being talked about</h5>
{% endif %}
    </div>
<div class="col-md-1">
<div class="pull-right" style="padding-left:0px;">

                   <button class="btn btn-primary pull-right save_and_next">Save & Move to next</button>
               </br>
                   <button type="button" class="btn btn-link skip_question">Skip This Question</button>
               </div>
</div>
    </div>
    <div class="row">
	   <div class="form-horizontal" role="form">

            <div class="col-md-6">
                {% if synonyms %}
	           <div class="panel panel-info">
              <div class="panel-heading">
              {% if concept_type == 'entity_url' %}
                  Suggestions:
                  {% else %}Prefer to choose 1 answer below. You can choose multiple only if it is very very necessary{% endif %}
              </div>
              <div class="panel-body" style="height:400px; overflow-y:scroll;">
	           <div class="form-group">
                   {% for synonym in synonyms %}
		           {% for surface_text, val in synonym.items %}
                      <div class="col-md-12 synonym_checkbox">
		                  <div class="checkbox-inline">
		                    <label>
		                      <input class="synonyms" name="bold[]" type="checkbox" value="{{ val.id }}" {% if val.checked %}Checked{% endif %}><span class="surface_text">{{ surface_text }}</span>

                                <span class="text-muted">
                                    {% if concept_type == 'entity_url' %}
                                    ({{ val.frequency }}) {% endif %}
                                    {% if user.is_superuser %}
                                    {% for trainer in val.trainers %} <span class="label label-primary" style = "background-color: {{ trainer|get_colourcode }}"> {{ trainer|getusername }}</span>{% endfor %}</span>
                                    {% endif %}
                            </label>
		                  </div>
                         <span class="glyphicon glyphicon-play pull-right text-muted" aria-hidden="true" style="padding-top:5px; font-size: 15px;"></span>
                          <i class="loader pull-right"><img src="http://jalbum.net/en/resources/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/indicator.gif"></i>
	                  </div>

	              {% endfor %}
                   {% endfor %}
              </div>
              </div>
              </div>
              {% endif %}
	       </div>
           <div class="col-md-6" id="wikki-div">
            <div id="wikki-text">
                <span id="redirected_text" class="text-warning"></span>
               <h4></h4>
               <div class="wiki-image pull-right"></div>
                <p></p>
            </div>
               <h5 class="text-muted"></h5>
           </div>
            <div class="col-md-12">
                              {% if concept_type == "entity_url" %}
                <div class="panel panel-info">
              <div class="panel-heading">
              Didn't find the right name? Enter your own naming suggestion for '{{text}}'
              </div>
              <div class="panel-body">
              <div class="col-md-12">
               <div class="form-group">
                    <textarea class="form-control" name="user_defined[]" id="user_defined"></textarea>
                    <p class="help-block">For  multiple values use a comma as separator. For e.g Sub, Submarine Sandwich</p>
               </div>
               </div>
               </div>
               </div>
                {% endif %}
            </div>
           <div class="col-md-12">

		       <div class="form-group col-md-12 pull-right">
                   <button class="btn btn-primary pull-right save_and_next">Save & Move to next</button>
               </div>
               <div class="pull-right" style="padding-left:0px;">
                     <!--<p class="text-muted" style="margin-bottom:0;">unsure about suggestions ??</p>-->

                   <button type="button" class="btn btn-link skip_question">Skip This Question</button>
                     {% if skipped_by and user.is_superuser %}
               </div>
               <div class=" col-md-12">
                     <p class="text-muted pull-right">Already skipped by : {% for trainer in skipped_by %}<span class="label label-default" style="margin-right: 3px;background-color: {{ trainer|get_colourcode }}"> {{ trainer|getusername }}</span>{% endfor %}</p>
                   </div>
                   {% endif %}
                 </div>
           </div>
       </div>
        {% else %}
        <div class="alert alert-warning" role="alert">
            No further information is available. (The requested entity is unknown)
        </div>
        {% endif %}
	</div>

{% endblock %}
{% block jquery %}
<script>
    $(document).ready(function(e){
        checked = [];
        unchecked = [];
        question = ['{{ question }}',{{ frequency }},'{{ concept_type }}']
        var url = '';
        $(".save_and_next").on("click", function(){
            $('input.synonyms[type=checkbox]').each(function () {
                (this.checked ? checked.push($(this).val()) : unchecked.push($(this).val()));
            });
        {% if concept_type == "surface_text" %}
        user_defined = ''
        url = "/review/save/surface_text/{{ entity }}"
        {% else %}
        url = "/review/save/{{ entity }}"
        user_defined =  $("#user_defined").val().split(',');
        {% endif %}

            $.ajax({
              type: "POST",
              url: url,
              data: {'checked': checked, 'unchecked': unchecked, 'user_defined': user_defined, 'question': question},
            }).success(function(){
                window.location.href = "/review";
            }).fail(function(){
                alert("failed");
            });
        });
        $(".skip_question").on("click", function(){
            $('input.synonyms[type=checkbox]').each(function () {
                unchecked.push($(this).val());
            });
            url = "/review/skip"
            $.ajax({
              type: "POST",
              url: url,
              data: {'synonyms': unchecked, 'question':question},
            }).success(function(data){
                window.location.href = "/review"

            }).fail(function(){
                alert("failed to upload result. Please try again.");
            });
        });

    $( ".synonym_checkbox").on('click', function() {
        var color = 'rgb(242, 239, 239)';
        $('.synonym_checkbox').filter(function(){
            return ($(this).css("background-color") == color);
        }).css("background-color", "white");

        var text =  $(this).find('label .surface_text').text();
        var $this = $(this);
        $this.find(".glyphicon").hide();
        $this.find(".loader").css("visibility", "visible");
        $this.css("background-color", color);
    var ajax_request = get_wikki_text(text, $this);
});
    function get_wikki_text(text, $this){
    $.ajax({
        type: "GET",
        url: "http://en.wikipedia.org/w/api.php?action=parse&format=json&prop=text&section=0&page="+text+"&callback=?",
        contentType: "application/json; charset=utf-8",
        async: false,
        dataType: "json",
        success: function (data, textStatus, jqXHR) {

            if (data.parse.title){
            var markup = data.parse.text["*"];
            var blurb = $('<div></div>').html(markup);
            // remove links as they will not work
            blurb.find('a').each(function() { $(this).replaceWith($(this).html()); });

            // remove any references
            blurb.find('sup').remove();

            // remove cite error
            blurb.find('.mw-ext-cite-error').remove();


            if ($(blurb).find('p').text() === "Redirect to:"){
                var text = $(blurb).find(".redirectText").text().split('#')
                $('#wikki-text #redirected_text').html("Redirected by wikipedia to " +text[0])
                get_wikki_text(text[0], $this);
            }
            else{
            $('#wikki-text h4').html(data.parse.title);
            if (blurb.find('.thumbinner')[0]){
            $('#wikki-text .wiki-image').html(blurb.find('.thumbinner')[0]).addClass('thumbnail').find(".thumbcaption").hide();
            }else{
            $('#wikki-text .wiki-image').html('');
            }
            $('#wikki-text p').html($(blurb).find('p').text());
            }
            }else{
            $('#wikki-text p').html("Not found");
            }

             $this.find(".glyphicon").show();
            $this.find(".loader").css("visibility", "hidden");
            $("#wikki-text").css("overflow-y", "scroll");
            $('#wikki-div').find('h5').html('For further information <a target="_blank" href="http://en.wikipedia.org/wiki/'+text+'" >Click Here</a> ')
        },
        error: function (errorMessage) {

        }
    });
}

});
</script>
{% endblock %}
